---
import Navigation from '../components/Navigation.astro';
import { ClientRouter } from 'astro:transitions';
import { getImage } from 'astro:assets';
import '../styles/global.css';

const { 
  title, 
  currentLang, 
  currentTag, 
  description = "Interactive language learning worksheets and tools for ESL students.",
  image = "/tj-logo-big-brighter.png",
  article = false
} = Astro.props;

// Map full language names to ISO 639-1 codes for Pagefind stemming support
const langMap: Record<string, string> = {
  english: 'en',
  french: 'fr',
  german: 'de',
  spanish: 'es',
  thai: 'th'
};
const isoLang = langMap[currentLang as string] || currentLang || 'en';

const canonicalURL = new URL(Astro.url.pathname, Astro.site || Astro.url);

// Optimize the social image
const optimizedImage = image ? await getImage({ 
  src: image, 
  width: 1200, 
  height: 630, 
  format: 'jpg' 
}) : null;

const socialImageURL = optimizedImage 
  ? new URL(optimizedImage.src, Astro.url)
  : new URL("/tj-logo-big-brighter.png", Astro.url);
---
<!doctype html>
<html lang={isoLang}>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="icon" type="image/x-icon" href="/favicon.ico" />
		<link rel="apple-touch-icon" href="/tj-logo.png" />
		<link rel="manifest" href="/site.webmanifest" />
		<link rel="icon" type="image/png" sizes="32x32" href="/tj-logo.png" />
		<link rel="icon" type="image/png" sizes="16x16" href="/tj-logo.png" />
		<meta name="generator" content={Astro.generator} />
		
    <!-- Primary Meta Tags -->
    <title>{title}</title>
    <link rel="canonical" href={canonicalURL} />
    <meta name="title" content={title} />
    <meta name="description" content={description} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={article ? 'article' : 'website'} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={socialImageURL} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={socialImageURL} />

    <!-- Google Fonts: Lora -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">

		<ClientRouter />
    <slot name="head" />
    
    <!-- Simple Analytics -->
    <script type="text/partytown" src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
	</head>
	<body class="bg-white min-h-screen text-slate-800 font-sans flex flex-col">
    <style is:global>
      html {
        scrollbar-gutter: stable;
      }
    </style>
    <noscript><img src="https://queue.simpleanalyticscdn.com/noscript.gif" alt="" referrerpolicy="no-referrer-when-downgrade" /></noscript>
    <Navigation currentLang={currentLang} currentTag={currentTag} />
    
    <main class="container mx-auto p-0 sm:p-4 max-w-6xl grow">
		  <slot />
    </main>

    <footer class="bg-transparent border-t border-slate-200 mt-auto py-8">
      <div class="container mx-auto px-4 max-w-6xl text-center">
        <p class="text-sm text-slate-500 mb-3">
          &copy; {new Date().getFullYear()} Teacher Jake. All rights reserved.
        </p>
        <div class="flex justify-center gap-6 text-sm font-medium">
          <a href="/privacy" class="text-emerald-700 hover:text-emerald-900 transition-colors">Privacy Policy</a>
        </div>
      </div>
    </footer>

    <!-- Global Loading Bar -->
    <div id="loading-bar" class="fixed top-0 left-0 h-1 bg-[#005522] z-100 transition-all duration-300 ease-out opacity-0 w-0"></div>

    <script is:inline>
      let loadingTimeout;
      document.addEventListener('astro:before-preparation', () => {
        const bar = document.getElementById('loading-bar');
        if (bar) {
          bar.style.width = '30%';
          bar.style.opacity = '1';
          
          // Move slowly after initial jump
          loadingTimeout = setTimeout(() => {
            bar.style.width = '70%';
          }, 300);
        }
      });

      document.addEventListener('astro:after-navigation', () => {
        const bar = document.getElementById('loading-bar');
        if (bar) {
          clearTimeout(loadingTimeout);
          bar.style.width = '100%';
          setTimeout(() => {
            bar.style.opacity = '0';
            setTimeout(() => {
              bar.style.width = '0';
            }, 300);
          }, 200);
        }
      });
    </script>
	</body>
</html>

