---
import Layout from '../layouts/Layout.astro';
import { getAllPosts } from "../lib/ghost-utils";
import { pb } from "../lib/pocketbase";
import { LANGUAGES } from "../utils/tags";
import WorksheetCard from "../components/WorksheetCard.astro";

let recentPosts: any[] = [];
try {
  // Fetch Pocketbase worksheets
  const records = await pb
    .collection("worksheets")
    .getFullList({ sort: "-created" });
  
  const pbWorksheets = records.map((record) => {
    let content = record.content;
    if (typeof content === "string") {
      try {
        content = JSON.parse(content);
      } catch (e) {}
    }

    const title = record.title || content?.title || "Untitled";
    let description = record.seo || content?.readingText || "";
    if (!record.seo && description.startsWith(title))
      description = description.substring(title.length).trim();
    description =
      description.substring(0, 120) + (description.length > 120 ? "..." : "");

    let imageUrl = record.image
      ? pb.files.getURL(record, record.image)
      : undefined;

    if (!imageUrl && record.videoUrl) {
      const regExp =
        /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
      const match = record.videoUrl?.match(regExp);
      const ytId = match && match[2].length === 11 ? match[2] : null;
      if (ytId)
        imageUrl = `https://img.youtube.com/vi/${ytId}/maxresdefault.jpg`;
    }

    return {
      type: "pb",
      id: record.id,
      title,
      slug: record.id,
      custom_excerpt: description,
      feature_image: imageUrl,
      tags: [
        { name: record.level || "All" },
        ...(record.tags || []).map((t: string) => ({ name: t })),
        { name: (record.language || "english").toLowerCase() },
      ],
      published_at: record.created,
      language: (record.language || "english").toLowerCase(),
    };
  });

  // Fetch Ghost posts
  let ghostPosts: any[] = [];
  try {
    ghostPosts = await getAllPosts({
      include: ["tags"],
    });
    ghostPosts = ghostPosts.map((post: any) => ({ ...post, type: "gh" }));
  } catch (e) {
    console.error(`Failed to fetch Ghost posts for home page`, e);
  }

  // Combine and sort
  recentPosts = [...ghostPosts, ...pbWorksheets].sort((a, b) => {
    const dateA = new Date(a.published_at || a.created_at || 0).getTime();
    const dateB = new Date(b.published_at || b.created_at || 0).getTime();
    return dateB - dateA;
  }).slice(0, 4);

} catch (e) {
  console.error("Error fetching recent posts for home page:", e);
}

const description = "Welcome to Teacher Jake. Explore our collection of interactive learning apps, digital worksheets, reading exercises, and language quizzes designed for classrooms or home learning.";
---
<Layout 
  title="Teacher Jake - Interactive Learning Materials" 
  description={description}
>
  <div class="max-w-5xl mx-auto px-4 py-4">
    <div class="text-center mb-16 pt-8">
      <h3 class="text-4xl font-bold text-green-800 mb-4">Teacher Jake's Language Lessons</h3>
      <!-- <Image src={logoImage} alt="TJ Logo" class="h-40 w-auto rounded shadow-inner mx-auto mb-4"/> -->
      <p class="text-xl text-[#4a5568] max-w-3xl mx-auto leading-relaxed">
        Discover a rich library of digital worksheets, engaging games, and reading exercises.
        Whether you're teaching in a classroom or learning at home, our tools are designed to 
        make language acquisition fun and effective.
      </p>
    </div>

    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-4 mb-16">
      {recentPosts.map((post) => {
        const langCode = post.language || (post.tags?.find((t: any) => ['english', 'french', 'german', 'spanish', 'thai'].includes(t.name.toLowerCase()))?.name.toLowerCase() || 'english');
        return <WorksheetCard post={post} lang={langCode} />;
      })}
    </div>

    <div class="mt-4 text-center border-t border-slate-100 pt-4">
      <h3 class="text-2xl font-bold text-green-800 mb-8">Browse Lessons by Language</h3>
      <div class="flex flex-wrap justify-center gap-4">
        {LANGUAGES.map((lang) => (
          <a
            href={`/${lang.code}`}
            data-astro-reload
            class="px-8 py-4 bg-white rounded-2xl shadow-sm border border-slate-100 text-lg font-bold text-blue-600 hover:shadow-md hover:-translate-y-1 transition-all duration-300 hover:text-blue-800"
          >
            {lang.label}
          </a>
        ))}
      </div>
    </div>
  </div>
</Layout>
