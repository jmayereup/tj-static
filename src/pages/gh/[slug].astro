---
import Layout from '../../layouts/Layout.astro';
import { Image } from 'astro:assets';
import { getAllPosts } from '../../lib/ghost-utils';
import { downloadGhostAsset, downloadGhostHtmlAssets } from '../../utils/downloadGhostAsset';
import { transformComponentsToScripts } from '../../utils/transformComponentsToScripts';
import { transformYouTubeEmbeds } from '../../utils/transformYouTubeEmbeds';

export async function getStaticPaths() {
  const posts = await getAllPosts({ include: ['tags'] });
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post: initialPost } = Astro.props;
const ogImage = initialPost.feature_image; // Original URL for OG
const post = { ...initialPost };

if (post.feature_image) {
    post.feature_image = await downloadGhostAsset(post.feature_image, post.slug);
}

if (post.html) {
    post.html = await downloadGhostHtmlAssets(post.html, post.slug, import.meta.env.GHOST_API_URL);
    post.html = transformComponentsToScripts(post.html);
    post.html = transformYouTubeEmbeds(post.html);
}

// Find if any tags require a specific web component script
const tagSlugs = post.tags?.map((t: any) => t.slug) || [];
const tagClassList = tagSlugs.map((slug: string) => `tag-${slug}`).join(' ');

// Find language for highlighting navigation
let currentLang = 'english';
const supportedLangs = ['english', 'french', 'german', 'spanish'];
for (const lang of supportedLangs) {
  if (tagSlugs.includes(lang)) {
    currentLang = lang;
    break;
  }
}

// Map of component tags to their script URLs
const componentScriptMap: Record<string, string> = {
    'tj-info-gap': 'https://scripts.teacherjake.com/tj-info-gap.js',
    'tj-chapter-book': 'https://scripts.teacherjake.com/tj-chapter-book.js',
    'tj-quiz-element': 'https://scripts.teacherjake.com/tj-quiz-element.js',
    'tj-speed-review': 'https://scripts.teacherjake.com/tj-speed-review.js',
    'tj-grammar-hearts': 'https://scripts.teacherjake.com/tj-grammar-hearts.js',
    'tj-reader': 'https://scripts.teacherjake.com/tj-reader.js',
    'tj-listening': 'https://scripts.teacherjake.com/tj-listening.js',
    'tj-pronunciation': 'https://scripts.teacherjake.com/tj-pronunciation.js'
};

// Fallback search based on tag slugs for legacy compatibility
const tagToComponentMap: Record<string, string> = {
    'information-gap': 'tj-info-gap',
    'book': 'tj-chapter-book',
    'quiz': 'tj-quiz-element',
    'speed-review': 'tj-speed-review',
    'grammar-hearts': 'tj-grammar-hearts',
    'lbl-reader': 'tj-reader',
    'listening': 'tj-listening',
    'pronunciation': 'tj-pronunciation'
};

const scriptsToLoad = new Set<string>();

// 1. Detect components by scanning HTML
if (post.html) {
  for (const [tag, scriptUrl] of Object.entries(componentScriptMap)) {
    if (post.html.includes(`<${tag}`)) {
      scriptsToLoad.add(scriptUrl);
    }
  }
}

// 2. Fallback: Detect components by tags (keeps legacy tagging working)
for (const tagSlug of tagSlugs) {
  const componentName = tagToComponentMap[tagSlug];
  if (componentName && componentScriptMap[componentName]) {
    scriptsToLoad.add(componentScriptMap[componentName]);
  }
}

const finalScripts = Array.from(scriptsToLoad);
---
<Layout 
  title={`${post.title} | Teacher Jake Worksheets`} 
  currentLang={currentLang}
  description={post.excerpt || post.custom_excerpt}
  image={ogImage}
  article={true}
>
  <Fragment slot="head">
    <!-- <link rel="stylesheet" href="https://language-learning-worksheets.pages.dev/wc/language-learning-worksheets.css"> -->
    {finalScripts.map(scriptUrl => (
      <script is:inline type="module" src={scriptUrl} defer crossorigin="anonymous"></script>
    ))}
  </Fragment>

  <article class={`prose lg:prose-xl max-w-[720px] mx-auto ${tagClassList}`} data-pagefind-body>
    {post.feature_image && (
        <div class="w-full max-h-[400px] bg-slate-50 sm:rounded-2xl sm:shadow-md mx-auto my-4 sm:my-8 overflow-hidden flex justify-center">
          <Image 
            src={post.feature_image} 
            alt={post.title} 
            width={1200}
            height={630}
            data-pagefind-meta="image[src]"
            class="max-h-[400px] object-contain" 
          />
        </div>
    )}
    
    <div class="worksheet-content" set:html={post.html} />
  </article>
</Layout>

<style is:global>
  @reference "../../styles/global.css";
  
  /* Standard content padding on mobile */
  .worksheet-content > *:not(tj-info-gap, tj-chapter-book, tj-quiz-element, tj-speed-review, tj-grammar-hearts, tj-reader, tj-listening, tj-pronunciation) {
    @apply px-4 sm:px-0;
  }

  /* Add prose styling to make Ghost html output look good */
  .worksheet-content :where(h1) {
    @apply text-4xl font-extrabold mt-12 mb-6 text-slate-900 tracking-tight;
  }
  .worksheet-content :where(h2) {
    @apply text-3xl font-bold mt-10 mb-4 text-slate-800 tracking-tight;
  }
  .worksheet-content :where(h3) {
    @apply text-2xl font-bold mt-8 mb-4 text-slate-800;
  }
  .worksheet-content :where(h4) {
    @apply text-xl font-bold mt-6 mb-2 text-slate-800;
  }
  .worksheet-content :where(h5) {
    @apply text-lg font-bold mt-4 mb-2 text-slate-800;
  }
  .worksheet-content :where(h6) {
    @apply text-base font-bold mt-4 mb-2 text-slate-800 uppercase tracking-wide;
  }
  .worksheet-content :where(p) {
    @apply mb-4 text-slate-700 leading-relaxed;
  }
  .worksheet-content :where(ul) {
    @apply list-disc list-inside mb-4 text-slate-700 space-y-2;
  }
  .worksheet-content :is(tj-info-gap, tj-chapter-book, tj-quiz-element, tj-speed-review, tj-grammar-hearts, tj-reader, tj-listening, tj-pronunciation) {
    @apply my-6 block w-full mx-auto;
  }

  /* Reduce top margin for the very first heading in the content */
  .worksheet-content > :first-child:is(h1, h2, h3, h4, h5, h6) {
    @apply mt-2;
  }

  /* Ghost Audio Card Styles - Hidden as they are only used to upload assets for web components */
  .worksheet-content .kg-audio-card {
    display: none;
  }

  /* Hide fallbacks once components are defined */
  :is(tj-info-gap, tj-chapter-book, tj-quiz-element, tj-speed-review, tj-grammar-hearts, tj-reader, tj-listening, tj-pronunciation):defined + .tj-fallback {
    display: none;
  }
</style>


