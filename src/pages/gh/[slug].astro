---
import Layout from '../../layouts/Layout.astro';
import { Image } from 'astro:assets';
import { getAllPosts } from '../../lib/ghost-utils';
import { downloadGhostAsset, downloadGhostHtmlAssets } from '../../utils/downloadGhostAsset';
import { transformComponentsToScripts } from '../../utils/transformComponentsToScripts';

export async function getStaticPaths() {
  const posts = await getAllPosts({ include: ['tags'] });
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post: initialPost } = Astro.props;
const ogImage = initialPost.feature_image; // Original URL for OG
const post = { ...initialPost };

if (post.feature_image) {
    post.feature_image = await downloadGhostAsset(post.feature_image, post.slug);
}

if (post.html) {
    post.html = await downloadGhostHtmlAssets(post.html, post.slug, import.meta.env.GHOST_API_URL);
    post.html = transformComponentsToScripts(post.html);
}

// Find if any tags require a specific web component script
const tagSlugs = post.tags?.map((t: any) => t.slug) || [];
const tagClassList = tagSlugs.map((slug: string) => `tag-${slug}`).join(' ');

// Find language for highlighting navigation
let currentLang = 'english';
const supportedLangs = ['english', 'french', 'german', 'spanish'];
for (const lang of supportedLangs) {
  if (tagSlugs.includes(lang)) {
    currentLang = lang;
    break;
  }
}

// Map of component tags to their script URLs
const componentScriptMap: Record<string, string> = {
    'tj-info-gap': 'https://scripts.teacherjake.com/tj-info-gap.js',
    'tj-chapter-book': 'https://scripts.teacherjake.com/tj-chapter-book.js',
    'tj-quiz-element': 'https://scripts.teacherjake.com/tj-quiz-element.js',
    'tj-speed-review': 'https://scripts.teacherjake.com/tj-speed-review.js',
    'tj-grammar-hearts': 'https://scripts.teacherjake.com/tj-grammar-hearts.js',
    'tj-reader': 'https://scripts.teacherjake.com/tj-reader.js',
    'tj-listening': 'https://scripts.teacherjake.com/tj-listening.js',
    'tj-pronunciation': 'https://scripts.teacherjake.com/tj-pronunciation.js'
};

// Fallback search based on tag slugs for legacy compatibility
const tagToComponentMap: Record<string, string> = {
    'information-gap': 'tj-info-gap',
    'book': 'tj-chapter-book',
    'quiz': 'tj-quiz-element',
    'speed-review': 'tj-speed-review',
    'grammar-hearts': 'tj-grammar-hearts',
    'lbl-reader': 'tj-reader',
    'listening': 'tj-listening',
    'pronunciation': 'tj-pronunciation'
};

const scriptsToLoad = new Set<string>();

// 1. Detect components by scanning HTML
if (post.html) {
  for (const [tag, scriptUrl] of Object.entries(componentScriptMap)) {
    if (post.html.includes(`<${tag}`)) {
      scriptsToLoad.add(scriptUrl);
    }
  }
}

// 2. Fallback: Detect components by tags (keeps legacy tagging working)
for (const tagSlug of tagSlugs) {
  const componentName = tagToComponentMap[tagSlug];
  if (componentName && componentScriptMap[componentName]) {
    scriptsToLoad.add(componentScriptMap[componentName]);
  }
}

const finalScripts = Array.from(scriptsToLoad);
---
<Layout 
  title={`${post.title} | Teacher Jake Worksheets`} 
  currentLang={currentLang}
  description={post.excerpt || post.custom_excerpt}
  image={ogImage}
  article={true}
>
  <Fragment slot="head">
    <link rel="stylesheet" href="https://jmayereup.github.io/language-learning-worksheets/dist/wc/language-learning-worksheets.css">
    {finalScripts.map(scriptUrl => (
      <script is:inline type="module" src={scriptUrl} defer crossorigin="anonymous"></script>
    ))}
  </Fragment>
  <div class="mb-6 pb-6 border-b border-slate-200">
    <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 tracking-tight">{post.title}</h1>
    
    <div class="flex gap-2 mt-4 flex-wrap">
      {post.tags?.map((tag: any) => (
        <span class="bg-emerald-50 text-emerald-700 px-3 py-1 rounded-full text-xs font-semibold uppercase tracking-wider">{tag.name}</span>
      ))}
    </div>
  </div>

  <article class={`prose lg:prose-xl max-w-[720px] mx-auto ${tagClassList}`} data-pagefind-body>
    {post.feature_image && (
        <div class="w-full max-h-[400px] bg-slate-50 rounded-2xl shadow-md mx-auto my-8 overflow-hidden flex justify-center">
          <Image 
            src={post.feature_image} 
            alt={post.title} 
            width={1200}
            height={630}
            class="max-h-[400px] object-contain" 
          />
        </div>
    )}
    
    <div class="worksheet-content" set:html={post.html} />
  </article>
</Layout>

<style is:global>
  @reference "../../styles/global.css";
  
  /* Add prose styling to make Ghost html output look good */
  .worksheet-content :where(h2) {
    @apply text-3xl font-bold mt-10 mb-4 text-slate-800;
  }
  .worksheet-content :where(p) {
    @apply mb-4 text-slate-700 leading-relaxed;
  }
  .worksheet-content :where(ul) {
    @apply list-disc list-inside mb-4 text-slate-700 space-y-2;
  }
  .worksheet-content :is(tj-info-gap, tj-chapter-book, tj-quiz-element, tj-speed-review, tj-grammar-hearts, tj-reader, tj-listening, tj-pronunciation) {
    @apply my-4 block w-full mx-auto;
  }

  /* Ghost Audio Card Styles - Hidden as they are only used to upload assets for web components */
  .worksheet-content .kg-audio-card {
    display: none;
  }
</style>


