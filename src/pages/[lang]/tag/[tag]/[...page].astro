---
import Layout from '../../../../layouts/Layout.astro';
import { getAllPosts } from '../../../../lib/ghost-utils';
import { LANGUAGES, CATEGORY_FILTERS, WORKSHEET_TOPICS } from '../../../../utils/tags';
import LevelFilter from '../../../../components/LevelFilter.astro';
import TopicFilter from '../../../../components/TopicFilter.astro';
import Pagination from '../../../../components/Pagination.astro';
import WorksheetCard from '../../../../components/WorksheetCard.astro';
import { pb } from '../../../../lib/pocketbase';
import { mapPbRecord } from '../../../../lib/pb-worksheet-mapper';

export async function getStaticPaths({ paginate }: any) {
  const allPaths: any[] = [];

  // Fetch all PocketBase worksheets once and normalize
  let allPbWorksheets: any[] = [];
  try {
    const records = await pb.collection('worksheets').getFullList({ sort: '-created' });
    allPbWorksheets = records.map(mapPbRecord);
  } catch (e) {
    console.warn("Failed to fetch PocketBase worksheets for tag pages", e);
  }

  for (const langObj of LANGUAGES) {
    const lang = langObj.code;
    let ghostPosts: any[] = [];
    try {
      ghostPosts = await getAllPosts({ filter: `tag:${lang}`, include: ['tags'] });
      ghostPosts = ghostPosts.map((post: any) => ({ ...post, source: 'ghost' }));
    } catch (e) {
      console.error(`Failed to fetch Ghost posts for ${lang}`, e);
    }

    const filterCategories = CATEGORY_FILTERS.filter((f: any) => f.id !== 'all');
    const worksheetTopics = WORKSHEET_TOPICS;

    // Combine standard categories and worksheet topics for routing
    const allTags = [
      ...filterCategories,
      ...worksheetTopics
    ];

    for (const category of allTags) {
      // 1. Ghost Content (match by tag slug)
      let filteredItems = ghostPosts.filter((post: any) =>
        post.tags?.some((t: any) => t.slug === category.id)
      );

      // 2. PocketBase Content
      // Check if this is a main lessonType category
      const isLessonType = ['speaking', 'worksheet', 'book'].includes(category.id);
      
      if (isLessonType) {
        const typeMatch =
          category.id === 'speaking' ? 'information-gap' :
          category.id === 'book' ? 'focused-reading' : 'worksheet';
        
        const matchingPb = allPbWorksheets.filter(
          (ws) => ws.language === lang && ws.lessonType === typeMatch
        );
        filteredItems = [...filteredItems, ...matchingPb];
      } else {
        // Assume it's a content topic tag (science, history, etc.)
        const matchingPb = allPbWorksheets.filter(
          (ws) => ws.language === lang && ws.tags?.some((t: any) => t.name.toLowerCase() === category.id.toLowerCase())
        );
        filteredItems = [...filteredItems, ...matchingPb];
      }

      // Sort combined results
      filteredItems.sort((a, b) => {
        const da = new Date(a.published_at || a.created_at || 0).getTime();
        const db = new Date(b.published_at || b.created_at || 0).getTime();
        return db - da;
      });

      const paginated = paginate(filteredItems, {
        params: { lang, tag: category.id },
        pageSize: 12,
      });

      allPaths.push(...paginated);
    }
  }

  return allPaths;
}

const { page } = Astro.props as { page: any };
const { lang, tag } = Astro.params;
const posts = page.data;

const titleMap: Record<string, string> = {
  french: 'French',
  german: 'German',
  spanish: 'Spanish',
  english: 'English',
  thai: 'Thai',
};

const displayLang = titleMap[lang as string] || lang;
const filterLabel = CATEGORY_FILTERS.find((f: any) => f.id === tag)?.label || 
                   WORKSHEET_TOPICS.find((f: any) => f.id === tag)?.label || 
                   (tag as string);

const isWorksheetRelated = tag === 'worksheet' || WORKSHEET_TOPICS.some(t => t.id === tag);
---
<Layout
  title={`Teacher Jake ${filterLabel} - ${displayLang} (Page ${page.currentPage})`}
  currentLang={lang}
  currentTag={tag}
>
  <div class="px-4">
    <div class="mb-4 text-center pt-2">
      <h1 class="text-4xl md:text-5xl font-extrabold mb-4 text-emerald-950 tracking-tight capitalize">
        {displayLang} {filterLabel}
      </h1>
      <p class="text-lg text-slate-600 max-w-2xl mx-auto">
        Browse our collection of interactive {displayLang}{" "}
        {(filterLabel as string).toLowerCase()} and language learning activities.
      </p>
    </div>
<div class="mb-4">
  <LevelFilter currentLang={lang as string} currentTag={tag as string} currentLevel="all" />
  {isWorksheetRelated && <TopicFilter currentLang={lang as string} currentTopic={tag as string} />}
</div>

    {posts.length === 0 ? (
      <div class="bg-amber-50 text-amber-800 p-6 rounded-xl border border-amber-200 text-center shadow-sm">
        <p class="text-lg font-medium">No {displayLang} {(filterLabel as string).toLowerCase()} found.</p>
        <p class="mt-2 opacity-80">Make sure your Ghost posts have the tag "{displayLang}".</p>
      </div>
    ) : (
      <div
        class="grid gap-6 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"
        transition:name="content-grid"
      >
        {posts.map((post: any) => (
          <WorksheetCard post={post} lang={lang as string} />
        ))}
      </div>
    )}

    <Pagination page={page} />
  </div>
</Layout>
