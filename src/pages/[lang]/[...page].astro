---
import Layout from "../../layouts/Layout.astro";
import { getAllPosts } from "../../lib/ghost-utils";
import { LANGUAGES } from "../../utils/tags";
import { pb } from "../../lib/pocketbase";
import LevelFilter from "../../components/LevelFilter.astro";
import Pagination from "../../components/Pagination.astro";
import WorksheetCard from "../../components/WorksheetCard.astro";

export async function getStaticPaths({ paginate }: any) {
  const allPaths: any[] = [];

  let allPbWorksheets: any[] = [];
  try {
    const records = await pb
      .collection("worksheets")
      .getFullList({ sort: "-created" });
    allPbWorksheets = records.map((record) => {
      let content = record.content;
      if (typeof content === "string") {
        try {
          content = JSON.parse(content);
        } catch (e) {}
      }

      const title = record.title || content?.title || "Untitled";
      let description = record.seo || content?.readingText || "";
      if (!record.seo && description.startsWith(title))
        description = description.substring(title.length).trim();
      description =
        description.substring(0, 120) + (description.length > 120 ? "..." : "");

      let imageUrl = record.image
        ? pb.files.getURL(record, record.image)
        : undefined;

      if (!imageUrl && record.videoUrl) {
        const regExp =
          /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = record.videoUrl?.match(regExp);
        const ytId = match && match[2].length === 11 ? match[2] : null;
        if (ytId)
          imageUrl = `https://img.youtube.com/vi/${ytId}/maxresdefault.jpg`;
      }

      return {
        type: "pb",
        id: record.id,
        title,
        slug: record.id,
        custom_excerpt: description,
        feature_image: imageUrl,
        tags: [
          { name: record.level || "All" },
          ...(record.tags || []).map((t: string) => ({ name: t })),
          { name: (record.language || "english").toLowerCase() },
        ],
        published_at: record.created,
        language: (record.language || "english").toLowerCase(),
      };
    });
  } catch (e) {
    console.warn("Could not fetch PocketBase worksheets in [...page].astro", e);
  }

  for (const langObj of LANGUAGES) {
    const lang = langObj.code;
    let posts: any[] = [];
    try {
      posts = await getAllPosts({
        filter: `tag:${lang}`,
        include: ["tags"],
      });
      posts = posts.map((post: any) => ({ ...post, type: "gh" }));
    } catch (e) {
      console.error(`Failed to fetch Ghost posts for ${lang}`, e);
    }

    const langPbWorksheets = allPbWorksheets.filter(
      (ws) => ws.language === lang
    );
    const combinedPosts = [...posts, ...langPbWorksheets].sort((a, b) => {
      const dateA = new Date(a.published_at || a.created_at || 0).getTime();
      const dateB = new Date(b.published_at || b.created_at || 0).getTime();
      return dateB - dateA;
    });

    const paginated = paginate(combinedPosts, {
      params: { lang },
      pageSize: 12,
    });

    allPaths.push(...paginated);
  }

  return allPaths;
}

const { page } = Astro.props as { page: any };
const { lang } = Astro.params;
const posts = page.data;

const titleMap: Record<string, string> = {
  french: "French",
  german: "German",
  spanish: "Spanish",
  english: "English",
  thai: "Thai",
};

const displayLang = titleMap[lang as string] || lang;
---

<Layout
  title={`Teacher Jake Worksheets - ${displayLang} (Page ${page.currentPage})`}
  currentLang={lang}
  description={`Browse our collection of interactive ${displayLang} language learning materials.`}
>
  <div class="px-4">
    <div class="mb-4 text-center pt-4">
    <h1
      class="text-4xl md:text-5xl font-extrabold mb-4 text-[#06422f] tracking-tight capitalize"
    >
      {displayLang}
    </h1>
    <p class="text-lg text-[#4a5568] max-w-2xl mx-auto">
      Browse our collection of interactive {displayLang} language learning materials,
      reading exercises, and quizzes.
    </p>
  </div>

  <LevelFilter currentLang={lang as string} currentLevel="all" />

  {
    posts.length === 0 ? (
      <div class="bg-amber-50 text-amber-800 p-6 rounded-xl border border-amber-200 text-center shadow-sm">
        <p class="text-lg font-medium">No {displayLang} worksheets found.</p>
        <p class="mt-2 opacity-80">
          Make sure your Ghost posts have the tag "{displayLang}".
        </p>
      </div>
    ) : (
      <div
        class="grid gap-6 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"
        transition:name="content-grid"
      >
        {posts.map((post: any) => (
          <WorksheetCard post={post} lang={lang as string} />
        ))}
      </div>
    )
  }

  <Pagination page={page} />
  </div>
</Layout>
