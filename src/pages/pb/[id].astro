---
import Layout from '../../layouts/Layout.astro';
import { pb } from '../../lib/pocketbase';
import { downloadAsset } from '../../utils/downloadAsset';

export async function getStaticPaths() {
  try {
    const worksheets = await pb.collection('worksheets').getFullList();
    return worksheets.map(worksheet => ({
      params: { id: worksheet.id },
      props: { worksheet },
    }));
  } catch (error) {
    console.warn("Failed to fetch from Pocketbase. Make sure your Pocketbase server is running.");
    return [];
  }
}

const { worksheet } = Astro.props as { worksheet: any };

let content = typeof worksheet.content === 'string' ? JSON.parse(worksheet.content || '{}') : (worksheet.content || {});

let imageUrl = worksheet.image ? pb.files.getURL(worksheet, worksheet.image) : undefined;

let audioFileUrl = worksheet.audioFile ? pb.files.getURL(worksheet, worksheet.audioFile) : undefined;
if (audioFileUrl) {
  audioFileUrl = await downloadAsset(audioFileUrl, worksheet.id, worksheet.audioFile);
}

const parsedLesson = {
  ...worksheet,
  content,
  image: imageUrl,
  audioFile: audioFileUrl
};
const ogImage = worksheet.image ? pb.files.getURL(worksheet, worksheet.image) : undefined;
const currentLang = (worksheet.language || 'English').toLowerCase();
---
<Layout 
  title={`${worksheet?.title || 'App'} | Teacher Jake App`} 
  currentLang={currentLang} 
  currentTag="worksheets"
  description={worksheet?.seo || worksheet?.description}
  image={ogImage}
>

  <article class="max-w-6xl mx-auto bg-white p-4 sm:p-6 sm:rounded-2xl sm:shadow-sm sm:border border-slate-100" data-pagefind-body>
    {ogImage && <img src={ogImage} alt="" data-pagefind-meta="image[src]" class="hidden" />}


    <!-- Web Component Wrapper -->
    <tj-pocketbase-worksheet>
      <script type="application/json" set:html={JSON.stringify(parsedLesson)} />
    </tj-pocketbase-worksheet>
  </article>
</Layout>
<style is:global>
  tj-pocketbase-worksheet {
    display: flex;
    width: 100%;
    margin-left: auto;
    margin-right: auto;
  }
</style>

<link rel="stylesheet" href="https://language-learning-worksheets.pages.dev/wc/language-learning-worksheets.css">

<script is:inline>
  // Ensure the script is only loaded when component is used
  if (!customElements.get('tj-pocketbase-worksheet')) {
     const script = document.createElement('script');
     script.src = 'https://language-learning-worksheets.pages.dev/wc/tj-pocketbase-worksheet.es.js'; 
     script.type = 'module';
     script.defer = true;
     document.head.appendChild(script);
  }
</script>
