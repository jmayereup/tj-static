---
import { Image } from "astro:assets";

interface Props {
  post: any;
  lang: string;
}

const { post, lang } = Astro.props;

const levelTag = post.tags?.find((tag: any) =>
  ["A1", "A2", "B1", "B2"].includes(tag.name)
);

const isPb = post.type === "pb" || post.source === "pocketbase";
const href = isPb ? `/pb/${post.slug || post.id}` : `/gh/${post.slug}`;
const displayLangPrefix = (lang || "").substring(0, 2).toUpperCase();

// Activity Type Detection & Tag Normalization
const postTags = post.tags || [];
const normalizedTags = postTags.map((t: any) => {
  const name = t.name || "";
  const slug = t.slug || "";
  const lowerName = name.toLowerCase();
  const lowerSlug = slug.toLowerCase();
  return {
    ...t,
    lowerName,
    lowerSlug,
    isInternal: lowerName.startsWith("#") || lowerSlug.startsWith("hash-"),
    // Strips both # and hash- prefixes
    cleanSlug: lowerSlug.replace(/^hash-/, "").replace(/^#/, ""),
    cleanName: lowerName.replace(/^#/, "")
  };
});

const tagCleanNames = normalizedTags.map((t: any) => t.cleanName);
const tagCleanSlugs = normalizedTags.map((t: any) => t.cleanSlug);
const allCleanTags = [...tagCleanNames, ...tagCleanSlugs];

let activityType = "";
if (isPb) {
  const lessonType = (post.lessonType || "").toLowerCase();
  if (lessonType === "worksheets" || lessonType === "worksheet") activityType = "WORKSHEET";
  else if (lessonType === "information-gap") activityType = "INFORMATION GAP";
  else if (lessonType === "focused-reading" || lessonType === "focused reader") activityType = "FOCUSED READER";
} else {
  if (allCleanTags.includes("lbl-reader")) activityType = "LINE-BY-LINE STORY";
  else if (allCleanTags.includes("book") && allCleanTags.includes("blb")) activityType = "BILINGUAL STORY";
  else if (allCleanTags.includes("book")) activityType = "CHAPTER STORY";
  else if (allCleanTags.includes("pronunciation") || allCleanTags.includes("pronunciaiton")) activityType = "PRONUNCIATION";
  else if (allCleanTags.includes("listening")) activityType = "LISTENING";
  else if (allCleanTags.includes("speaking")) activityType = "SPEAKING";
}
---

<a
  href={href}
  data-astro-reload
  class="group bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col h-full"
>
  <div class="aspect-video w-full shrink-0 bg-slate-50 loading-pulse flex items-center justify-center overflow-hidden relative border-b border-slate-100">
    {post.feature_image ? (
      <Image
        src={post.feature_image}
        alt={post.title}
        width={400}
        height={225}
        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
        loading="lazy"
        decoding="async"
      />
    ) : (
      <div class="w-full h-full flex items-center justify-center text-emerald-200">
        <svg
          class="w-12 h-12"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
          />
        </svg>
      </div>
    )}
  </div>

  <div class="grow p-5 flex flex-col">
    <div class="flex items-center gap-2 mb-3">
      {levelTag && (
        <span class="text-[10px] font-black tracking-wider text-emerald-700 uppercase bg-emerald-50 px-2 py-0.5 rounded border border-emerald-100">
          {displayLangPrefix}-{levelTag.name}
        </span>
      )}
      <div class="flex flex-wrap items-center gap-2">
        {levelTag && (
          <div class="h-1 w-1 rounded-full bg-slate-200" />
        )}
        {(() => {
          const lowerLang = (lang || "").toLowerCase();
          const displayTags = normalizedTags.filter(
            (t: any) =>
              !["a1", "a2", "b1", "b2", lowerLang].includes(t.cleanName) &&
              (isPb || !t.isInternal)
          );
          
          if (displayTags.length > 0) {
            return displayTags.map((tag: any) => (
              <span class="text-[10px] font-black tracking-wider text-emerald-700 uppercase bg-emerald-50 px-2 py-0.5 rounded border border-emerald-100">
                #{tag.cleanName}
              </span>
            ));
          }

          return (
            <span class="text-[10px] text-slate-400 font-medium tracking-wider uppercase">
              #{post.slug.substring(0, 4)}
            </span>
          );
        })()}
      </div>
    </div>
    <div class="min-h-24">
      <h2 class="font-extrabold text-blue-600 text-[1.15rem] leading-tight mb-2 group-hover:text-blue-800 transition-colors line-clamp-2">
        {post.title}
      </h2>
      <p class="text-slate-500 text-sm leading-relaxed line-clamp-3 mb-0 grow">
        {post.custom_excerpt || post.excerpt}
      </p>
    </div>

    <div class="pt-4 mt-auto border-t border-slate-100 flex items-center justify-between">
      <span class="text-[11px] font-extrabold tracking-widest text-blue-600 uppercase line-clamp-1">
        {activityType || (isPb ? "Start App" : "Start Worksheet")}
      </span>
      <div class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-all duration-300 shadow-sm group-hover:shadow-md">
        <svg
          class="w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M14 5l7 7m0 0l-7 7m7-7H3"
          />
        </svg>
      </div>
    </div>
  </div>
</a>
