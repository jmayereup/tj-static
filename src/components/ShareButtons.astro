---
interface Props {
  title?: string;
  description?: string;
  url?: string;
  class?: string;
}

const { 
  title = "Check out this lesson!", 
  description = "", 
  url: propUrl,
  class: className 
} = Astro.props;

// shareUrl will be handled client-side if propUrl is not provided
---

<div 
  class={`flex flex-wrap justify-end items-center gap-2 m-2 no-prose ${className}`} 
  data-share-container
  data-share-title={title}
  data-share-description={description}
  data-share-url={propUrl}
>
  <span class="text-sm font-bold text-slate-500 uppercase tracking-wider mr-2">Share:</span>
  
  <!-- Copy Link -->
  <button
    id="copy-link-btn"
    class="inline-flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-medium transition-all active:scale-95 group focus:outline-none focus:ring-2 focus:ring-slate-300"
    title="Copy link to clipboard"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:rotate-12 transition-transform"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
    <span class="btn-text sr-only">Copy</span>
  </button>

  <!-- Instagram -->
  <button
    id="share-instagram"
    class="inline-flex items-center gap-2 px-3 py-2 bg-gradient-to-tr from-[#f9ce34] via-[#ee2a7b] to-[#6228d7] hover:opacity-90 text-white rounded-lg text-sm font-medium transition-all active:scale-95 group focus:outline-none focus:ring-2 focus:ring-[#ee2a7b]"
    title="Share on Instagram"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
  </button>

  <!-- Facebook -->
  <a
    id="share-facebook"
    href="#"
    target="_blank"
    rel="noopener noreferrer"
    class="inline-flex items-center gap-2 px-3 py-2 bg-[#1877F2]/10 hover:bg-[#1877F2]/20 text-[#1877F2] rounded-lg text-sm font-medium transition-all active:scale-95 group focus:outline-none focus:ring-2 focus:ring-[#1877F2]"
    title="Share on Facebook"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>
  </a>

  <!-- Web Share API (Mobile native share) -->
  <button
    id="native-share-btn"
    class="hidden items-center gap-2 px-3 py-2 bg-emerald-100 hover:bg-emerald-200 text-emerald-800 rounded-lg text-sm font-medium transition-all active:scale-95 group focus:outline-none focus:ring-2 focus:ring-emerald-300"
    title="More share options"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
    <span>More</span>
  </button>
</div>

<script>
  function initShareButtons() {
    const containers = document.querySelectorAll('[data-share-container]');
    
    containers.forEach(container => {
      const title = container.getAttribute('data-share-title');
      const description = container.getAttribute('data-share-description');
      const propUrl = container.getAttribute('data-share-url');
      const url = propUrl || window.location.href;
      
      const encodedUrl = encodeURIComponent(url);
      const encodedTitle = encodeURIComponent(title || '');

      // Facebook
      const facebook = container.querySelector('#share-facebook') as HTMLAnchorElement;
      if (facebook) {
        facebook.href = `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`;
      }

      // Shared logic for native sharing
      const performNativeShare = async () => {
        if ('share' in navigator) {
          try {
            // Messenger and some other apps duplicate the summary if you send both title and text.
            // We combine them into text and omit title for a cleaner experience.
            await navigator.share({
              text: `${title}${description ? '\n\n' + description : ''}`,
              url: url,
            });
          } catch (err) {
            if ((err as Error).name !== 'AbortError') {
              console.error('Error sharing:', err);
            }
          }
        }
      };

      // Instagram (using Native Share if available)
      const instagramBtn = container.querySelector('#share-instagram');
      if (instagramBtn) {
        instagramBtn.addEventListener('click', async () => {
          if ('share' in navigator) {
            await performNativeShare();
          } else {
            // Fallback: Copy link
            try {
              const nav = navigator as any;
              if (nav.clipboard) {
                await nav.clipboard.writeText(url);
                const originalTitle = instagramBtn.getAttribute('title');
                instagramBtn.setAttribute('title', 'Link Copied!');
                setTimeout(() => {
                  instagramBtn.setAttribute('title', originalTitle || '');
                }, 2000);
              }
            } catch (err) {
              console.error('Failed to copy link:', err);
            }
          }
        });
      }

      // Native Share ("More" button)
      const nativeBtn = container.querySelector('#native-share-btn') as HTMLElement;
      if (nativeBtn && 'share' in navigator) {
        nativeBtn.classList.remove('hidden');
        nativeBtn.classList.add('inline-flex');
        nativeBtn.addEventListener('click', performNativeShare);
      }

      // Copy Link
      const copyBtn = container.querySelector('#copy-link-btn');
      if (copyBtn) {
        copyBtn.addEventListener('click', async () => {
          const nav = navigator as any;
          if (nav.clipboard) {
            try {
              await nav.clipboard.writeText(url);
              const btnText = copyBtn.querySelector('.btn-text');
              const originalText = btnText ? btnText.textContent : '';
              if (btnText) btnText.textContent = 'Copied!';
              
              copyBtn.classList.add('bg-emerald-100', 'text-emerald-800');
              copyBtn.classList.remove('bg-slate-100', 'text-slate-700');
              
              setTimeout(() => {
                if (btnText) btnText.textContent = originalText;
                copyBtn.classList.remove('bg-emerald-100', 'text-emerald-800');
                copyBtn.classList.add('bg-slate-100', 'text-slate-700');
              }, 2000);
            } catch (err) {
              console.error('Failed to copy:', err);
            }
          }
        });
      }
    });
  }

  // Initialize on page load and after swaps
  document.addEventListener('astro:page-load', initShareButtons);
</script>
