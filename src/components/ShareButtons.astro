---
interface Props {
  title?: string;
  description?: string;
  url?: string;
  class?: string;
}

const { 
  title = "Check out this lesson!", 
  description = "", 
  url: propUrl,
  class: className 
} = Astro.props;

// We'll use a client-side script to get the actual URL if not provided
const shareUrl = propUrl;
---

<div class={`flex flex-wrap justify-end items-center gap-2 m-2 no-prose ${className}`} data-share-container>
  <span class="text-sm font-bold text-slate-500 uppercase tracking-wider mr-2">Share:</span>
  
  <!-- Copy Link -->
  <button
    id="copy-link-btn"
    class="inline-flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-medium transition-all active:scale-95 group focus:outline-none focus:ring-2 focus:ring-slate-300"
    title="Copy link to clipboard"
    data-url={shareUrl}
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:rotate-12 transition-transform"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
    <!-- <span class="btn-text">Copy</span> -->
  </button>

  <!-- Instagram -->
  <button
    id="share-instagram"
    class="inline-flex items-center gap-2 px-3 py-2 bg-gradient-to-tr from-[#f9ce34] via-[#ee2a7b] to-[#6228d7] hover:opacity-90 text-white rounded-lg text-sm font-medium transition-all active:scale-95 group focus:outline-none focus:ring-2 focus:ring-[#ee2a7b]"
    title="Share on Instagram"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
    <!-- <span>IG</span> -->
  </button>

  <!-- Facebook -->
  <a
    id="share-facebook"
    href="#"
    target="_blank"
    rel="noopener noreferrer"
    class="inline-flex items-center gap-2 px-3 py-2 bg-[#1877F2]/10 hover:bg-[#1877F2]/20 text-[#1877F2] rounded-lg text-sm font-medium transition-all active:scale-95 group focus:outline-none focus:ring-2 focus:ring-[#1877F2]"
    title="Share on Facebook"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>
    <!-- <span>Share</span> -->
  </a>

  <!-- Web Share API (Mobile native share) -->
  <button
    id="native-share-btn"
    class="hidden items-center gap-2 px-3 py-2 bg-emerald-100 hover:bg-emerald-200 text-emerald-800 rounded-lg text-sm font-medium transition-all active:scale-95 group focus:outline-none focus:ring-2 focus:ring-emerald-300"
    title="More share options"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
    <span>More</span>
  </button>
</div>

<script is:inline define:vars={{ title, description, propUrl }}>
  document.addEventListener('astro:page-load', () => {
    const url = propUrl || window.location.href;
    const encodedUrl = encodeURIComponent(url);
    const encodedTitle = encodeURIComponent(title);
    const encodedDesc = encodeURIComponent(description);

    const facebook = document.getElementById('share-facebook');
    if (facebook) facebook.href = `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`;

    // Handle Instagram (primarily via Web Share API)
    const instagramBtn = document.getElementById('share-instagram');
    if (instagramBtn) {
      instagramBtn.addEventListener('click', async () => {
        if (navigator.share) {
          try {
            await navigator.share({
              title: title,
              text: description,
              url: url,
            });
          } catch (err) {
            console.error('Error sharing to Instagram/Native:', err);
          }
        } else {
          // Fallback: Copy link if Web Share is not available
          try {
            await navigator.clipboard.writeText(url);
            const btnText = instagramBtn.querySelector('span');
            const originalText = btnText.textContent;
            btnText.textContent = 'Link Copied!';
            setTimeout(() => {
              btnText.textContent = originalText;
            }, 2000);
          } catch (err) {
            console.error('Failed to copy link via Instagram button:', err);
          }
        }
      });
    }

    // Handle Native Share
    const nativeBtn = document.getElementById('native-share-btn');
    if (nativeBtn && navigator.share) {
      nativeBtn.classList.remove('hidden');
      nativeBtn.classList.add('inline-flex');
      nativeBtn.addEventListener('click', async () => {
        try {
          await navigator.share({
            title: title,
            text: description,
            url: url,
          });
        } catch (err) {
          console.error('Error sharing:', err);
        }
      });
    }

    // Handle Copy Link
    const copyBtn = document.getElementById('copy-link-btn');
    if (copyBtn) {
      copyBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(url);
          const btnText = copyBtn.querySelector('.btn-text');
          const originalText = btnText.textContent;
          btnText.textContent = 'Copied!';
          copyBtn.classList.add('bg-emerald-100', 'text-emerald-800');
          copyBtn.classList.remove('bg-slate-100', 'text-slate-700');
          
          setTimeout(() => {
            btnText.textContent = originalText;
            copyBtn.classList.remove('bg-emerald-100', 'text-emerald-800');
            copyBtn.classList.add('bg-slate-100', 'text-slate-700');
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });
    }
  });
</script>
